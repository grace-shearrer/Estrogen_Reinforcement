---
title: "PEAS_E_reinforcment"
author: "Grace Shearrer"
date: "3/11/2020"
output: html_document
---
# Title
Effect of estrogen and dietary sugar intake on food reinforcement in pre and postpartum women

# Description
This is a secondary data analysis examining the relationship between dietary sugar intake, estrogen, and food reinforcement between pregnancy and the postpartum period. Estrogen has been related to a decrease in motivation for a sugar reward in animal models. Further estrogen has been shown to increase prediction errors in the nucleus accumbens. Together this suggests that estrogen is related to dopaminergic signaling and behaviorally this manifests as a reduction in the rewarding aspects of sugar. However, in the addiction literature, estrogen has been shown to increase motivation for illicit substances and alcohol. The differences between sugar and other rewards is not fully understood. During pregnancy, estrogen levels increases exponentially. This provides an interesting model to test the effect of estrogen on food reward and the effect of sugar intake. 

# Hypotheses
Aim1. To test the interactive effects of estrogen and added sugar intake on motivation for a reward, we will assess: 
* serum estrogen
* percent added sugar intake from 2 diet recalls
* motivation (food reinforcement scale) from the PEAS dataset both in the pregnancy and postpartum period. 

We expect a significant interaction between added sugar intake and estrogen. Specifically we expect high dietary sugar intake will ablate the reward diminishing effect of estrogen during pregnancy (these women will show high pregnancy reward values, compared to low sugar intake). 

# Design Plan
## Study type
Observational Study - Data is collected from study subjects that are not randomly assigned to a treatment. This includes surveys, “natural experiments,” and regression discontinuity designs.

## Blinding
No blinding is involved in this study.
Is there any additional blinding in this study?
No response

## Study design
This study was completed in 2016. It was a longitudinal observational study of women in and around the Chapel Hill area from 12 wks pregnancy through 1yr postpartum. Details have been published here.
Pregnancy eating attributes study (PEAS): a cohort study examining behavioral and environmental influences on diet and weight change in pregnancy and postpartum.

Nansel TR, Lipsky LM, Siega-Riz AM, Burger K, Faith M, Liu A
BMC Nutr. 2016 Jul 15; 2


## Sampling Plan
Existing Data
Registration prior to analysis of the data

## Explanation of existing data
While I have previously published on this dataset, it was a small subset of the total dataset. I have not looked at any summary statistics for the whole dataset outside of completion rates as the data was collected. 

## Data collection procedures
Please see the attached file for total data collection procedures. 
## Load packages
```{r}
library(psych)
library(ggplot2)
library(reshape2)
library(nlme)
library(plyr)
library(emmeans)
library(car)
library(MASS)
require(foreign)
require(MASS)
require(Hmisc)
require(ordinal)
```

## Load data
```{r}
baseline<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/BASE_PREG_copy.csv", sep=",", header=T)
post<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/moma_post.CSV", sep=",", header=T)
post_scores<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/SCORES_POST.CSV", sep=",", header=T)
preg_scores<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/SCORES_PREG.CSV", sep=",", header=T)
preg_demos<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/MOMA_Preg copy.csv", sep=",", header=T)
preg_ses<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/SES_PREG.csv", sep=",", header=T)
bloodv2<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/blood_v2.csv", sep=",", header=T)
bloodv5<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/blood_v5.csv", sep=",", header=T)
diet<-read.table("~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/HEI2015SCORE_POST.csv", sep=",", header=T)
names(post)
```

## Variables of interest
```{r}
base_vars<-c("PATID", "BMI", "AGE_Y", "PARITY", "DEM_ETHNICITY", "DEM_RACE")
post_svar<-c("PATID", "VISNO", "frh_bkpnt","frh_omax","frh_pmax", "frl_bkpnt","frl_omax","frl_pmax","frh_intensity","frl_intensity","FRH_ELASTICITY_KOFF")
preg_svar<-c("PATID", "VISNO", "FRH_BKPNT","FRH_OMAX", "FRH_PMAX","FRH_PMAX_PRICE","FRH_PCTCOMP","FRL_BKPNT","FRL_OMAX","FRL_PMAX","FRL_PMAX_PRICE", "FRL_PCTCOMP" )
demos<-c("PATID","VISNO","MomA_BMI")
ses<-c("PATID","VISNO","DEM_SNAP")
diet_vars<-c("PATID","KCAL", "sfat_kcal_post","sfat_pct_post","HEI2015C12_SFAT", "addsug_kcal_post","addsug_pct_post", "HEI2015C13_ADDSUG","sfat_as_kcal_post", "sfat_as_pct_post")
post_vars<-c("PATID", "VISNO", "MomA_BMICH")
```

## Collect varaibles of interest
```{r}
base_df<-baseline[base_vars]
colnames(base_df)<-c("PATID","BMI_0","AGE_Y","PARITY","DEM_ETHNICITY", "DEM_RACE")

post_df<-post_scores[post_svar]
post_df<-subset(post_df, post_df$VISNO == 2)
summary(post_df)
colnames(post_df)<-c("PATID", "postVISNO", "FRH_BKPNT_2","FRH_OMAX_2","FRH_PMAX_2", "FRL_BKPNT_2","FRL_OMAX_2","FRL_PMAX_2","frh_intensity","frl_intensity","FRH_ELASTICITY_KOFF")

preg_df<-preg_scores[preg_svar]
preg_df<-subset(preg_df, preg_df$VISNO == 1)
summary(preg_df)
colnames(preg_df)<-c("PATID", "pregVISNO", "FRH_BKPNT_1","FRH_OMAX_1", "FRH_PMAX_1","FRH_PMAX_PRICE_1","FRH_PCTCOMP_1","FRL_BKPNT_1","FRL_OMAX_1","FRL_PMAX_1","FRL_PMAX_PRICE_1", "FRL_PCTCOMP_1" )

demo_df<-preg_demos[demos]
demo_df<-subset(demo_df, demo_df$VISNO == 1)
colnames(demo_df)<-c("PATID","VISNO_1","MomA_BMI")
ses_df<-preg_ses[ses]
ses_df<-subset(ses_df, ses_df$VISNO == 1)
names(ses_df)

diet_df<-diet[diet_vars]

demopost_df<-post[post_vars]
head(demopost_df)
demopost_df<-subset(demopost_df, demopost_df$VISNO == 2)
colnames(demopost_df)<-c("PATID", "VISNO_2", "MomA_BMICH")

summary(demopost_df)
colnames(bloodv2)<-c("PATID","CReactiveProtein_1", "CPeptide_1", "Glucose_1","Insulin_1", "Progesterone_1", "Estradiol_1")
colnames(bloodv5)<-c("PATID","CReactiveProtein_2", "CPeptide_2", "Glucose_2","Insulin_2", "Progesterone_2", "Estradiol_2")
```

## Combing datasets into final df
```{r}
blood_df<-join(bloodv2,bloodv5)
scores_df<-join(preg_df,post_df)
demopp_df<-join(demo_df,demopost_df)
summary(demopp_df)
demoses_df<-join(ses_df,demopp_df)
cov_df<-join(demoses_df, base_df)

int_df<-join(blood_df, scores_df)
dint_df<-join(int_df, diet_df)
df<-join(dint_df, cov_df)
vars<-c("PATID", "Estradiol_1","Estradiol_2","FRH_BKPNT_1","FRH_OMAX_1", "FRH_PMAX_1","FRL_BKPNT_1","FRL_OMAX_1","FRL_PMAX_1", "FRH_BKPNT_2","FRH_OMAX_2","FRH_PMAX_2", "FRL_BKPNT_2","FRL_OMAX_2","FRL_PMAX_2", "KCAL", "sfat_kcal_post","sfat_pct_post","HEI2015C12_SFAT","addsug_kcal_post","addsug_pct_post","HEI2015C13_ADDSUG","sfat_as_kcal_post","sfat_as_pct_post","DEM_SNAP","MomA_BMI","BMI_0","AGE_Y","PARITY","DEM_ETHNICITY", "DEM_RACE","MomA_BMICH" )
wide_df<-df[vars]
```

## Wide to long
```{r}
summary(wide_df)
wide_df$Estradiol_1<-as.numeric(wide_df$Estradiol_1)
wide_df$Estradiol_2<-as.numeric(wide_df$Estradiol_2)

long_df<-reshape(wide_df, varying=list( Estradiol=c(2,3), FRH_BKPNT=c(4,10), FRH_OMAX=c(5,11), FRH_PMAX=c(6,12), FRL_BKPNT=c(7,13), FRL_OMAX=c(8, 14), FRL_PMAX=c(9, 15)),  v.names=c("Estrodiol",  "high_breakpoint", "high_OMAX","high_PMAX","low_breakpoint","low_OMAX","low_PMAX"), 
          # that was needed after changed 'varying' arg to a list to allow 'times' 
        direction="long",  
        times=1:2,        # substitutes number for T1 and T2
        timevar="Time")  # to name the time col
# write.table(long_df, "~/Google Drive/Projects/13-3848_PEAS/SSIB2020/data/long_data.csv", sep=",", row.names = F)
```

## Set factors
```{r}
names(long_df)
long_df$PATID<-as.factor(long_df$PATID)
long_df$DEM_ETHNICITY<-as.factor(long_df$DEM_ETHNICITY)
long_df$DEM_RACE<-as.factor(long_df$DEM_RACE)
long_df$DEM_SNAP<-as.factor(long_df$DEM_SNAP)
long_df$PARITY<-as.factor(long_df$PARITY)
long_df$Estrodiol<-as.numeric(long_df$Estrodiol)
describeBy(long_df$Estrodiol, long_df$Time)
```

```{r}
hist(long_df$Estrodiol)
hist(long_df$MomA_BMICH) # square is a lot better
long_df$sqrtBMICH<-sqrt(7.5-long_df$MomA_BMICH)
hist(long_df$sqrtBMICH) # square is a lot better
describe(long_df$MomA_BMICH)
hist(long_df$AGE_Y)
hist(sqrt(long_df$addsug_pct_post)) #this is good
long_df$sqrtPerAddSug<-sqrt(long_df$addsug_pct_post)
hist(long_df$low_breakpoint)
hist(long_df$high_breakpoint)
# reinforcement is real,real skewed will need to check each model 
```

## For this analysis women will be excluded if: <- need to ask for these 
They have less than 2 recalls in the pre and postpartum period.
They underwent sterilization in the postpartum period.
They reported postpartum depression.
They reported taking psychiatric medications or medications related to steroid hormones or related to body mass

## Sample size
450 in the overall sample
360 with measures needed
199 with frl_bkpnt 

## Measured variables
### Experimental
Estradiol at 16-22 week pregnancy and 6 months postpartum 
Dietary sugar intake at baseline, 16-22 week pregnancy, and 6 months postpartum
Reinforcement measures (breakpoint and omax) change from baseline, 16-22 week pregnancy, and 6 months postpartum 
### FRH_BKPNT	8	FOOD REINFORCEMENT (EPSTEIN) HIGH PALATABLE, BREAKPOINT <- use
Will need to create groups due to extreme skew
### FRL_BKPNT	8	FOOD REINFORCEMENT (EPSTEIN) LOW PALATABLE, BREAKPOINT <- use
Will need to create groups due to extreme skew
### Covariates
#### Race/ethnicity
DEM_RACE
#### SES
DEM_SNAP
#### Parity 
PARITY
#### BMI (change from baseline at 16-22wks pregnancy and 6mo postpartum)
MomA_BMICH
#### Age
AGE_Y
# Analysis Plan
We will use a oridnal logistic regression to assess the interaction of added sugar intake and estradiol concentrations on reinforcement. We run a series of models to assess the effect of the independent variables of interest:
1) baseline model (intercept only with covariates)

## Statistical models - Baseline model
```{r}
quantile(long_df$low_breakpoint, na.rm = T)

long_df$low_bp[long_df$low_breakpoint<=200]<-"1"
long_df$low_bp[long_df$low_breakpoint>200 & long_df$low_breakpoint<=300]<-"2"
long_df$low_bp[long_df$low_breakpoint>300 & long_df$low_breakpoint<=500]<-"3"
long_df$low_bp[long_df$low_breakpoint>500]<-"4"

quantile(long_df$high_breakpoint, na.rm = T)

long_df$high_bp[long_df$high_breakpoint<200]<-"1"
long_df$high_bp[long_df$high_breakpoint>=200 & long_df$high_breakpoint<300]<-"2"
long_df$high_bp[long_df$high_breakpoint>=300 & long_df$high_breakpoint<500]<-"3"
long_df$high_bp[long_df$high_breakpoint>=500]<-"4"
long_df$high_bp<-as.factor(long_df$high_bp)
long_df$low_bp<-as.factor(long_df$low_bp)

summary(as.factor(long_df$high_bp))
summary(as.factor(long_df$low_bp))
long_df$Time<-as.factor(long_df$Time)

long_df<-na.omit(long_df)
```

# Summaries
```{r}
ggplot(long_df, aes(x = high_bp, y = Estrodiol, color = Time)) +
  geom_boxplot(size = .75) +
  geom_jitter(alpha = .5) +
  ggtitle("Estrogen vs. high palatability breakpoint in pregnacy") +
  xlab("High palatability breakpoint groups") + ylab("Estrodiol") +
  theme_classic()
```


```{r}
ggplot(long_df, aes(x = low_bp, y = Estrodiol, color = Time)) +
  geom_boxplot(size = .75) +
  geom_jitter(alpha = .5) +
  ggtitle("Estrogen vs. low palatability breakpoint in pregnacy") +
  xlab("Low palatability breakpoint groups") + ylab("Estrodiol") +
  theme_classic()
```

# Ordinal logistic regression
Can't do normal regression with a factor as the outcome. Can't do binary logistic regression with more than two outcome variables. Need to use ordinal logistic regression.  https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/
## Centering
```{r}
library(misty)
long_df$Estrodiol_c<-center(long_df$Estrodiol, type = c("CGM"))
long_df$Age_c<-center(long_df$AGE_Y, type = c("CGM"))
long_df$BMICH_c<-center(long_df$MomA_BMICH, type = c("CGM"))
summary(long_df$BMICH_c)
summary(long_df$Estrodiol_c)
summary(long_df$Age_c)
```

```{r}
m0 <- polr(high_bp ~ 1+Estrodiol_c+Time, data = long_df, Hess=TRUE)
summary(m0)

## view a summary of the model
summary(m0)
(ctable0 <- coef(summary(m0)))
## calculate and store p values
p0 <- pnorm(abs(ctable0[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable0 <- cbind(ctable0, "p value" = p0))

(ci0 <- confint(m0)) # default method gives profiled CIs
ci0.1<-confint.default(m0) # CIs assuming normality
## odds ratios
exp(coef(m0))
## OR and CI
exp(cbind(OR = coef(m0), ci0))
vif(m0)
```
```{r}
fm1 <- clmm2(high_bp ~ Estrodiol_c+Time, random=PATID, data=long_df)
fm1

fm2 <- clmm2(high_bp ~ Estrodiol_c*Time, random=PATID, data=long_df, Hess=TRUE, nAGQ=5)
summary(fm2)
```


```{r}
## Cumulative link model with one random term:
fmm1 <- clmm(high_bp ~ Estrodiol_c+Time + (1|Time:Estrodiol_c), data = long_df)
summary(fmm1)
## Not run:
## May take a couple of seconds to run this.
## Cumulative link mixed model with two random terms:
mm1 <- clmm(SURENESS ~ PROD + (1|RESP) + (1|RESP:PROD), data = soup,
link = "probit", threshold = "equidistant")
mm1
summary(mm1)
## test random effect:
mm2 <- clmm(SURENESS ~ PROD + (1|RESP), data = soup,
link = "probit", threshold = "equidistant")
anova(mm1, mm2)
## End(Not run)
```

```{r}
## fit ordered logit model and store results 'm'
long_df$high_bp<-as.factor(long_df$high_bp)
long_df$high_bp <- factor(long_df$high_bp, levels = c("1", "2", "3", "4"))

m1 <- polr(high_bp ~ Estrodiol+Time+MomA_BMICH+DEM_RACE+DEM_ETHNICITY+AGE_Y+PARITY+DEM_SNAP, data = long_df, Hess=TRUE)

## view a summary of the model
summary(m1)
(ctable1 <- coef(summary(m1)))
## calculate and store p values
p1 <- pnorm(abs(ctable1[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable1 <- cbind(ctable1, "p value" = p1))

(ci1 <- confint(m1)) # default method gives profiled CIs
ci1.1<-confint.default(m1) # CIs assuming normality
## odds ratios
exp(coef(m1))
## OR and CI
exp(cbind(OR = coef(m1), ci1.1))
```
### Summary this is nice, but it is missing the random effects of time.... 
The first step in a multilevel analysis such as this is to assess the need to do it in the first place. If there is not significant variation across contexts in the first place then doing a multilevel model is simply a perverse exercise in mental flagellation. If there is little evidence of variation across contexts then save yourself a lot of pain and just do a regression/ANOVA/ whatever variant of the general linear model that you feel like doing.
Ascertaining whether there is variation over your contexts is fairly straightforward. First, we need to fit a baseline model in which we include only the intercept; next, we fit a model that allows intercepts to vary over contexts; finally we compare these two models to see whether the fit has improved as a result of allowing intercepts to vary. If it has, we jump on the runaway train to multilevel insanity; if it has not, we do a little dance of joy into the loving arms of a simpler life.
```{r}
## Cumulative link model with no random term:
m <- polr(high_bp ~ Time+MomA_BMICH+DEM_RACE+DEM_ETHNICITY+AGE_Y+PARITY+DEM_SNAP, data = long_df_om, Hess=TRUE)
## view a summary of the model
summary(m)

summary(long_df$Time)

fmm0 <- clmm(high_bp ~ MomA_BMICH+DEM_RACE+DEM_ETHNICITY+AGE_Y+PARITY+DEM_SNAP+Time, data = long_df_om, na.action = na.omit)
summary(fmm0)
lrtest(m, fmm0)
# Looks like the random term doesn't make a difference
```

2) interaction model (interaction term with covariates)
```{r}
m1 <- polr(high_bp ~ Estrodiol+MomA_BMICH+DEM_RACE+DEM_ETHNICITY+AGE_Y+PARITY+DEM_SNAP+Time, data = long_df_om, Hess=TRUE)
## view a summary of the model
summary(m1)
(ctable1 <- coef(summary(m1)))
## calculate and store p values
p1 <- pnorm(abs(ctable1[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable1 <- cbind(ctable1, "p value" = p1))

ci1<-confint.default(m1) # CIs assuming normality
## odds ratios
exp(coef(m1))
## OR and CI
exp(cbind(OR = coef(m1), ci1))

fmm1 <- clmm(high_bp ~ Estrodiol+MomA_BMICH+DEM_RACE+DEM_ETHNICITY+AGE_Y+PARITY+DEM_SNAP+Time+(1|PATID), data = long_df_om, na.action = na.omit)
summary(fmm1)
# PATID doesn't improve the model
lrtest(m1, fmm1)
```


```{r}
library(repolr)
long_df_om$high_bp<-as.numeric(as.character(long_df_om$high_bp))
long_df_om$Estrodiol<-as.numeric(long_df_om$Estrodiol)

mod.0 <- repolr(high_bp ~ Estrodiol+Time, data=long_df, categories=4, subjects="PATID", times=c(1,2), corr.mod="uniform", alpha=0.5)
summary(mod.0)
summary(update(mod.0, diffmeth = "numeric"))
summary(update(mod.0, fixed = TRUE, alpha =0.5))
```

We will assess differences between the two models using an anova. 
Estradiol and added sugar intake will be random intercepts.
All analysis will take place in R. p > 0.05. Bonferroni corrections 

